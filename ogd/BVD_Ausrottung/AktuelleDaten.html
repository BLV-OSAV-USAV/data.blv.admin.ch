// TEST

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        #tooltip {
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            width: 150px;
            position: absolute;
        }

        circle {
            filter: drop-shadow(0px 4px 4px rgba(0, 0, 0, 0.25));
        }
    </style>
</head>
<body>
    <div id="tooltip"></div>
    <div id="visualization"></div>

    <script>
        // Language selection
        const language = 'en'; // Change 'en' to 'fr' for French

        // Translations object with HTML <br> line breaks
        const translations = {
            en: {
                grey: "not assessed <br> (grey)",
                green: "negligible <br> (green)",
                orange: "intermediate <br> (orange)",
                red: "high <br> (red)",
                percent: "Percentage",
                farms: "establishments"
            },
            fr: {
                grey: "non évalué <br> (gris)",
                green: "négligeable <br> (vert)",
                orange: "intermédiaire <br> (orange)",
                red: "élevé <br> (rouge)",
                percent: "Pourcentage",
                farms: "établissements"
            }
        };

        // Data for circles
        const data = [
            {'BVD_AMPEL': 'orange', 'N_FARMS': 4772, 'PERCENT': 13.8, 'diff': -10}, 
            {'BVD_AMPEL': 'green', 'N_FARMS': 29620, 'PERCENT': 85.9, 'diff': 18}, 
            {'BVD_AMPEL': 'red', 'N_FARMS': 101, 'PERCENT': 0.3, 'diff': 98}
        ];

        const width = 1000;
        const height = 300;
        const padding = 20;

        // Create the SVG element
        const svg = d3.select("#visualization")
                      .append("svg")
                      .attr("viewBox", `0 0 ${width} ${height}`)
                      .attr("preserveAspectRatio", "xMidYMid meet");

        const radiusScale = d3.scaleSqrt()
                              .domain([0, d3.max(data, d => d.N_FARMS)])
                              .range([0, 100]);

        // Add circles with dynamic x-coordinate placement
        let currentX = 0;
        svg.selectAll("circle")
           .data(data)
           .enter()
           .append("circle")
           .attr("cx", (d, i) => {
               const r = radiusScale(d.N_FARMS) + 10;
               currentX += r + (i === 0 ? 0 : padding);
               const cx = currentX;
               currentX += r;
               return cx;
           })
           .attr("cy", height / 2)
           .attr("r", d => radiusScale(d.N_FARMS))
           .attr("fill", d => d.BVD_AMPEL)
           .on("mouseover", function(event, d) {
                const tooltipWidth = 150;
                const tooltipHeight = 50;

                // Dynamically render the tooltip content with HTML <br>
                d3.select("#tooltip")
                    .style("left", (event.pageX - tooltipWidth / 2) + "px")
                    .style("top", (event.pageY - tooltipHeight - 10) + "px")
                    .style("display", "block")
                    .style("opacity", 1)
                    .html(`
                        <strong>${translations[language][d.BVD_AMPEL]}</strong>
                        <br>
                        ${d.PERCENT}% (${d.N_FARMS} ${translations[language].farms})
                    `);
           })
           .on("mouseout", function() {
                d3.select("#tooltip").style("opacity", 0);
           });

        // Add text labels below circles (can use .text() if plain text is desired)
        currentX = 0;
        // Render text labels below each circle
        svg.selectAll("text")
           .data(data)
           .enter()
           .append("text")
           .attr("x", (d, i) => {
               const r = radiusScale(d.N_FARMS) + 10;
               currentX += r + (i === 0 ? 0 : padding);
               const cx = currentX;
               currentX += r;
               return cx;
           })
           .attr("y", height - 20)
           .attr("text-anchor", "middle")
           .style("font-size", "12px")
           .style("font-family", 'Poppins, sans-serif')
           .each(function(d) {
               const textElement = d3.select(this);
               const lines = translations[language][d.BVD_AMPEL].split("<br>");

               lines.forEach((line, index) => {
                   textElement.append("tspan")
                       .attr("x", textElement.attr("x"))  // align tspans to the same x
                       .attr("dy", index === 0 ? 0 : 15)  // add vertical spacing between lines
                       .text(line.toUpperCase());
               });
           });
       
    </script>

</body>
</html>
